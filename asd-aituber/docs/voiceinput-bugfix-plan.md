# éŸ³å£°å…¥åŠ›ã‚¨ã‚³ãƒ¼ãƒ«ãƒ¼ãƒ—å•é¡Œã®ä¿®æ­£è¨ˆç”»

## ğŸš¨ å•é¡Œã®æ¦‚è¦

### ç¾åœ¨ã®å•é¡Œ
éŸ³å£°å…¥åŠ›æ™‚ã«ã€ã‚·ã‚¹ãƒ†ãƒ ãŒç™ºè©±ä¸­ã‚‚ãƒã‚¤ã‚¯ãŒèãå–ã‚ŠçŠ¶æ…‹ã®ã¾ã¾ã«ãªã£ã¦ãŠã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã®éŸ³å£°å‡ºåŠ›ã‚’ãã®ã¾ã¾èãå–ã£ã¦ã—ã¾ã„ã€ç„¡é™ãƒ«ãƒ¼ãƒ—ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã€‚

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ã“ã‚“ã«ã¡ã¯" 
  â†“ (éŸ³å£°èªè­˜)
ã‚·ã‚¹ãƒ†ãƒ : "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ" ğŸ”Š
  â†“ (ãƒã‚¤ã‚¯ãŒèãå–ã‚Šç¶™ç¶šä¸­)
ã‚·ã‚¹ãƒ†ãƒ : "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ" (è‡ªåˆ†ã®å£°ã‚’èªè­˜)
  â†“ (ç„¡é™ãƒ«ãƒ¼ãƒ—)
ã‚·ã‚¹ãƒ†ãƒ : "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ" ğŸ”Š
```

### æœŸå¾…ã™ã‚‹å‹•ä½œ
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ã“ã‚“ã«ã¡ã¯" 
  â†“ (éŸ³å£°èªè­˜)
ã‚·ã‚¹ãƒ†ãƒ : ãƒã‚¤ã‚¯åœæ­¢ ğŸ¤âŒ
  â†“
ã‚·ã‚¹ãƒ†ãƒ : "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ" ğŸ”Š
  â†“ (éŸ³å£°å‡ºåŠ›å®Œäº†å¾Œ)
ã‚·ã‚¹ãƒ†ãƒ : ãƒã‚¤ã‚¯å†é–‹ ğŸ¤âœ…
```

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. éŸ³å£°èªè­˜ã®ç¶™ç¶šçŠ¶æ…‹
- `SpeechRecognition.continuous = true` ã«ã‚ˆã‚Šå¸¸æ™‚èãå–ã‚Š
- ã‚·ã‚¹ãƒ†ãƒ ç™ºè©±ä¸­ã‚‚ãƒã‚¤ã‚¯ãŒæ´»æ€§çŠ¶æ…‹
- å‡ºåŠ›éŸ³å£°ãŒãƒã‚¤ã‚¯ã«æˆ»ã‚Šè¾¼ã‚€ï¼ˆã‚¨ã‚³ãƒ¼ç¾è±¡ï¼‰

### 2. éŸ³å£°å‡ºåŠ›ã¨ã®éåŒæœŸæ€§
- éŸ³å£°åˆæˆé–‹å§‹/çµ‚äº†ã®çŠ¶æ…‹ç®¡ç†ãŒä¸å®Œå…¨
- éŸ³å£°èªè­˜ã¨ã®é€£æºæ©Ÿèƒ½ãªã—
- è¤‡æ•°ã®éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆVOICEVOX/Web Speechï¼‰ã®çŠ¶æ…‹çµ±åˆãªã—

### 3. ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢çš„è¦å› 
- ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã¨ãƒã‚¤ã‚¯ã®ç‰©ç†çš„è·é›¢
- ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã®ä¸å‚™
- ã‚·ã‚¹ãƒ†ãƒ éŸ³é‡è¨­å®šã®å½±éŸ¿

---

## ğŸ”¥ è¿½åŠ èª¿æŸ»: éŸ³å£°åˆæˆAPI vs å®Ÿéš›ã®éŸ³å£°ç™ºè©±ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°å·®å•é¡Œ (2025/01/06)

### ğŸš¨ **ç¾åœ¨ã®å®Ÿè£…ã®è‡´å‘½çš„æ¬ é™¥**

#### å•é¡Œã®æ ¸å¿ƒ: **éŸ³å£°åˆæˆAPIå®Œäº† â‰  å®Ÿéš›ã®éŸ³å£°ç™ºè©±å®Œäº†**

```typescript
// âŒ ç¾åœ¨ã®å®Ÿè£…ï¼ˆå•é¡Œã‚ã‚Šï¼‰
useEffect(() => {
  if (isSpeaking) {
    // éŸ³å£°åˆæˆAPIé–‹å§‹æ™‚ã«ãƒã‚¤ã‚¯OFF
    stopListening()
  } else {
    // éŸ³å£°åˆæˆAPIçµ‚äº†æ™‚ã«ãƒã‚¤ã‚¯ON â† ã“ã‚ŒãŒå•é¡Œï¼
    startListening()  // ã¾ã ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‹ã‚‰éŸ³ãŒå‡ºã¦ã„ã‚‹å¯èƒ½æ€§
  }
}, [isSpeaking])
```

#### **ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆ†æ**:
```
T=0s   ãƒ¦ãƒ¼ã‚¶ãƒ¼: "ã“ã‚“ã«ã¡ã¯"
T=1s   éŸ³å£°åˆæˆAPIå‘¼ã³å‡ºã—é–‹å§‹ â†’ isSpeaking=true â†’ ãƒã‚¤ã‚¯OFF âœ…
T=2s   éŸ³å£°åˆæˆAPIå‡¦ç†å®Œäº† â†’ isSpeaking=false â†’ ãƒã‚¤ã‚¯ON âŒ (å•é¡Œç™ºç”Ÿç‚¹)
T=3s   å®Ÿéš›ã®éŸ³å£°ç™ºè©±é–‹å§‹ ğŸ”Š "ã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿ"
T=6s   å®Ÿéš›ã®éŸ³å£°ç™ºè©±ç¶™ç¶šä¸­ ğŸ”Š + ãƒã‚¤ã‚¯ON â†’ ã‚¨ã‚³ãƒ¼ãƒ«ãƒ¼ãƒ—ç™ºç”Ÿ âŒ
T=8s   å®Ÿéš›ã®éŸ³å£°ç™ºè©±çµ‚äº†
```

#### **ã‚¨ã‚³ãƒ¼ãƒ«ãƒ¼ãƒ—ã®å…·ä½“çš„ç™ºç”Ÿãƒ¡ã‚«ãƒ‹ã‚ºãƒ **:
1. **T=2s**: éŸ³å£°åˆæˆAPIãŒå®Œäº† â†’ `isSpeaking=false`
2. **T=2s**: VoiceInputãŒãƒã‚¤ã‚¯ã‚’è‡ªå‹•ONã«ã™ã‚‹
3. **T=3s-T=8s**: ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã‹ã‚‰å®Ÿéš›ã®éŸ³å£°ãŒå‡ºåŠ›ä¸­
4. **T=3s-T=8s**: ãƒã‚¤ã‚¯ãŒã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³å£°ã‚’æ‹¾ã„ç¶šã‘ã‚‹
5. **T=8s**: éŸ³å£°èªè­˜ãŒã€Œã“ã‚“ã«ã¡ã¯ï¼å…ƒæ°—ã§ã™ã‹ï¼Ÿã€ã¨ã—ã¦èªè­˜
6. **T=9s**: æ–°ãŸãªéŸ³å£°åˆæˆãŒé–‹å§‹ã•ã‚Œã‚‹ â†’ ã‚¨ã‚³ãƒ¼ãƒ«ãƒ¼ãƒ—å®Œæˆ

#### **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ã®å‰¯ä½œç”¨**:
```typescript
// 30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ã‚‚å•é¡Œã‚’æ‚ªåŒ–
setTimeout(() => {
  setMicTimeoutOverride(true) // éŸ³å£°ç™ºè©±ä¸­ã§ã‚‚å¼·åˆ¶ãƒã‚¤ã‚¯ON
}, 30000)
```

### ğŸ¯ **çœŸã®è§£æ±ºç­–ã®è¦ä»¶**

#### **å¿…è¦ãªåˆ¶å¾¡ãƒ•ãƒ­ãƒ¼**:
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼éŸ³å£°å…¥åŠ›
2. éŸ³å£°åˆæˆAPIé–‹å§‹ â†’ ãƒã‚¤ã‚¯OFF
3. éŸ³å£°åˆæˆAPIå®Œäº†
4. å®Ÿéš›ã®éŸ³å£°ç™ºè©±é–‹å§‹ (HTMLAudioElement.play())
5. å®Ÿéš›ã®éŸ³å£°ç™ºè©±çµ‚äº† (HTMLAudioElement.onended)
6. 1ç§’é–“ã®å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³
7. ãƒã‚¤ã‚¯ON
```

#### **ç›£è¦–ã™ã¹ãå®Ÿéš›ã®çŠ¶æ…‹**:
- `isSpeaking` (éŸ³å£°åˆæˆAPIçŠ¶æ…‹) âŒ
- `isActuallyPlayingAudio` (HTMLAudioElementå†ç”ŸçŠ¶æ…‹) âœ…

#### **å®Ÿè£…ã™ã¹ãæ©Ÿèƒ½**:
1. **HTMLAudioElementã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç›£è¦–**
   ```typescript
   audio.onplay = () => setIsActuallyPlaying(true)
   audio.onended = () => {
     setIsActuallyPlaying(false)
     setTimeout(() => startListening(), 1000) // 1ç§’å¾Œã«ãƒã‚¤ã‚¯ON
   }
   ```

2. **éŸ³å£°ç™ºè©±ä¸­ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ç„¡åŠ¹åŒ–**
   ```typescript
   // å®Ÿéš›ã®éŸ³å£°ç™ºè©±ä¸­ã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ã‚’åœæ­¢
   if (isActuallyPlayingAudio) {
     clearTimeout(micTimeoutRef.current)
   }
   ```

3. **è¤‡æ•°éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³å¯¾å¿œ**
   - VOICEVOX: HTMLAudioElementçµŒç”±
   - WebSpeechAPI: SpeechSynthesis.speakingç›£è¦–

### ğŸ“Š **ä¿®æ­£å„ªå…ˆåº¦**

#### **Critical Priority (å³åº§ä¿®æ­£å¿…è¦)**:
1. HTMLAudioElement.onended ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
2. éŸ³å£°ç™ºè©±å®Œäº†ã‹ã‚‰1ç§’å¾Œã®ãƒã‚¤ã‚¯ON
3. éŸ³å£°ç™ºè©±ä¸­ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ç„¡åŠ¹åŒ–

#### **High Priority**:
1. è¤‡æ•°éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã®çµ±ä¸€åˆ¶å¾¡
2. ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

#### **Medium Priority**:
1. éŸ³å£°ç™ºè©±ã®é‡è¤‡åˆ¶å¾¡
2. ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š

## ğŸ¯ ä¿®æ­£æˆ¦ç•¥

### Phase 1: åŸºæœ¬çš„ãªãƒã‚¤ã‚¯åˆ¶å¾¡
1. **éŸ³å£°å‡ºåŠ›é€£å‹•ãƒã‚¤ã‚¯åˆ¶å¾¡**
   - éŸ³å£°åˆæˆé–‹å§‹æ™‚ã«è‡ªå‹•çš„ã«ãƒã‚¤ã‚¯åœæ­¢
   - éŸ³å£°åˆæˆçµ‚äº†æ™‚ã«è‡ªå‹•çš„ã«ãƒã‚¤ã‚¯å†é–‹
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ï¼ˆæœ€å¤§30ç§’å¾Œã«å¼·åˆ¶å†é–‹ï¼‰

### Phase 2: çµ±åˆéŸ³å£°çŠ¶æ…‹ç®¡ç†
2. **UnifiedVoiceController ã®å®Ÿè£…**
   - éŸ³å£°èªè­˜ã¨éŸ³å£°åˆæˆã®çµ±åˆçŠ¶æ…‹ç®¡ç†
   - `isSpeaking` ãƒ•ãƒ©ã‚°ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡
   - ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å¾©æ—§æ©Ÿèƒ½

### Phase 3: é«˜åº¦ãªã‚¨ã‚³ãƒ¼å¯¾ç­–
3. **éŸ³éŸ¿ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - Web Audio API ã«ã‚ˆã‚‹éŸ³éŸ¿å‡¦ç†
   - é©å¿œãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹ã‚¨ã‚³ãƒ¼é™¤å»
   - éŸ³é‡ãƒ¬ãƒ™ãƒ«ç›£è¦–ã«ã‚ˆã‚‹å‹•çš„åˆ¶å¾¡

## ğŸ“‹ å®Ÿè£…è¨ˆç”»ï¼ˆTDDï¼‰

### Phase 1.1: åŸºæœ¬ãƒã‚¤ã‚¯åˆ¶å¾¡å®Ÿè£…

#### Task 1.1.1: VoiceInputã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ‹¡å¼µ
```typescript
interface VoiceInputProps {
  // æ—¢å­˜ã®props...
  disabled?: boolean // å¤–éƒ¨ã‹ã‚‰ã®ç„¡åŠ¹åŒ–åˆ¶å¾¡
  onStateChange?: (isListening: boolean) => void // çŠ¶æ…‹å¤‰åŒ–é€šçŸ¥
}
```

#### Task 1.1.2: éŸ³å£°åˆæˆé–‹å§‹æ™‚ã®ãƒã‚¤ã‚¯åœæ­¢
```typescript
// useChat.tså†…
const handleSendMessage = async (message: string) => {
  // ãƒã‚¤ã‚¯ã‚’åœæ­¢
  setMicrophoneDisabled(true)
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å‡¦ç†...
  await sendMessage(message)
}
```

#### Task 1.1.3: éŸ³å£°åˆæˆçµ‚äº†æ™‚ã®ãƒã‚¤ã‚¯å†é–‹
```typescript
// UnifiedVoiceSynthesis callbacks
onEnd: () => {
  // éŸ³å£°åˆæˆçµ‚äº†
  setMicrophoneDisabled(false) // ãƒã‚¤ã‚¯å†é–‹
},
onError: () => {
  // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å¿…ãšå†é–‹
  setMicrophoneDisabled(false)
}
```

### Phase 1.2: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·æ©Ÿèƒ½

#### Task 1.2.1: å¼·åˆ¶ãƒã‚¤ã‚¯å†é–‹ã‚¿ã‚¤ãƒãƒ¼
```typescript
useEffect(() => {
  if (microphoneDisabled) {
    // 30ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒã‚¤ã‚¯å†é–‹
    const timer = setTimeout(() => {
      console.warn('[VoiceInput] å¼·åˆ¶ãƒã‚¤ã‚¯å†é–‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰')
      setMicrophoneDisabled(false)
    }, 30000)
    
    return () => clearTimeout(timer)
  }
}, [microphoneDisabled])
```

### Phase 2.1: çµ±åˆéŸ³å£°çŠ¶æ…‹ç®¡ç†

#### Task 2.1.1: VoiceStateManager ã®ä½œæˆ
```typescript
interface VoiceState {
  isListening: boolean    // éŸ³å£°èªè­˜ä¸­
  isSpeaking: boolean     // éŸ³å£°åˆæˆä¸­
  isProcessing: boolean   // AIå‡¦ç†ä¸­
  microphoneEnabled: boolean
}

class VoiceStateManager {
  private state: VoiceState
  private listeners: ((state: VoiceState) => void)[]
  
  startSpeaking() {
    this.setState({
      isSpeaking: true,
      microphoneEnabled: false // è‡ªå‹•ã§ãƒã‚¤ã‚¯åœæ­¢
    })
  }
  
  stopSpeaking() {
    this.setState({
      isSpeaking: false,
      microphoneEnabled: true // è‡ªå‹•ã§ãƒã‚¤ã‚¯å†é–‹
    })
  }
}
```

#### Task 2.1.2: React Hookçµ±åˆ
```typescript
export function useVoiceState() {
  const [state, setState] = useState<VoiceState>(defaultState)
  
  const startSpeaking = useCallback(() => {
    voiceStateManager.startSpeaking()
  }, [])
  
  const stopSpeaking = useCallback(() => {
    voiceStateManager.stopSpeaking()
  }, [])
  
  return { state, startSpeaking, stopSpeaking }
}
```

### Phase 2.2: çµ±åˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ›´æ–°

#### Task 2.2.1: ChatPage ã®çµ±åˆ
```typescript
export default function ChatPage() {
  const { state, startSpeaking, stopSpeaking } = useVoiceState()
  
  // éŸ³å£°åˆæˆé–‹å§‹æ™‚
  useEffect(() => {
    if (newAssistantMessage) {
      startSpeaking() // ãƒã‚¤ã‚¯ã‚’è‡ªå‹•åœæ­¢
      
      speakText(message.content, {
        callbacks: {
          onEnd: () => {
            stopSpeaking() // ãƒã‚¤ã‚¯ã‚’è‡ªå‹•å†é–‹
          },
          onError: () => {
            stopSpeaking() // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†é–‹
          }
        }
      })
    }
  }, [messages])
  
  return (
    <VoiceInput 
      disabled={state.isSpeaking || state.isProcessing}
      onStateChange={(listening) => {
        // çŠ¶æ…‹å¤‰åŒ–ã‚’çµ±åˆç®¡ç†
      }}
    />
  )
}
```

### Phase 3.1: é«˜åº¦ãªã‚¨ã‚³ãƒ¼å¯¾ç­–

#### Task 3.1.1: AudioContext ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```typescript
class EchoCancellation {
  private audioContext: AudioContext
  private microphoneStream: MediaStream
  private outputMonitor: AnalyserNode
  
  async initialize() {
    // ãƒã‚¤ã‚¯å…¥åŠ›ã®å–å¾—
    this.microphoneStream = await navigator.mediaDevices.getUserMedia({
      audio: {
        echoCancellation: true,  // ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        noiseSuppression: true,
        autoGainControl: true
      }
    })
    
    // å‡ºåŠ›éŸ³å£°ã®ç›£è¦–
    this.outputMonitor = this.audioContext.createAnalyser()
    // ã‚·ã‚¹ãƒ†ãƒ éŸ³å£°å‡ºåŠ›ã¨é€£æº...
  }
  
  isEchoDetected(): boolean {
    // å‡ºåŠ›éŸ³å£°ãƒ¬ãƒ™ãƒ«ã¨å…¥åŠ›éŸ³å£°ãƒ¬ãƒ™ãƒ«ã®ç›¸é–¢åˆ†æ
    // é–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã¯ã‚¨ã‚³ãƒ¼ã¨åˆ¤å®š
  }
}
```

#### Task 3.1.2: å‹•çš„éŸ³é‡åˆ¶å¾¡
```typescript
class AdaptiveVolumeControl {
  adjustSystemVolume(inputLevel: number) {
    // å…¥åŠ›éŸ³å£°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ éŸ³é‡ã‚’å‹•çš„èª¿æ•´
    // é«˜ã„å…¥åŠ› â†’ ä½ã„å‡ºåŠ›éŸ³é‡ã§ã‚¨ã‚³ãƒ¼ã‚’é˜²æ­¢
  }
  
  detectFeedbackLoop(): boolean {
    // éŸ³å£°ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‘¨æœŸæ€§åˆ†æ
    // ãƒ«ãƒ¼ãƒ—æ¤œå‡ºæ™‚ã¯ç·Šæ€¥åœæ­¢
  }
}
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### Unit Tests
```typescript
describe('VoiceStateManager', () => {
  test('éŸ³å£°åˆæˆé–‹å§‹æ™‚ã«ãƒã‚¤ã‚¯ãŒåœæ­¢ã•ã‚Œã‚‹', () => {
    const manager = new VoiceStateManager()
    manager.startSpeaking()
    expect(manager.getState().microphoneEnabled).toBe(false)
  })
  
  test('éŸ³å£°åˆæˆçµ‚äº†æ™‚ã«ãƒã‚¤ã‚¯ãŒå†é–‹ã•ã‚Œã‚‹', () => {
    const manager = new VoiceStateManager()
    manager.startSpeaking()
    manager.stopSpeaking()
    expect(manager.getState().microphoneEnabled).toBe(true)
  })
  
  test('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«å¼·åˆ¶çš„ã«ãƒã‚¤ã‚¯ãŒå†é–‹ã•ã‚Œã‚‹', async () => {
    const manager = new VoiceStateManager()
    manager.startSpeaking()
    
    // 30ç§’å¾…æ©Ÿã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    jest.advanceTimersByTime(30000)
    
    expect(manager.getState().microphoneEnabled).toBe(true)
  })
})
```

### Integration Tests
```typescript
describe('VoiceInput Integration', () => {
  test('ã‚·ã‚¹ãƒ†ãƒ ç™ºè©±ä¸­ã¯ãƒã‚¤ã‚¯ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹', async () => {
    const { getByTestId } = render(<ChatPage />)
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    fireEvent.click(getByTestId('send-button'))
    
    // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    expect(getByTestId('microphone-button')).toBeDisabled()
  })
  
  test('éŸ³å£°åˆæˆçµ‚äº†å¾Œã«ãƒã‚¤ã‚¯ãŒå†é–‹ã•ã‚Œã‚‹', async () => {
    // éŸ³å£°åˆæˆã®å®Œäº†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    // ãƒã‚¤ã‚¯ã®å†é–‹ã‚’ç¢ºèª
  })
})
```

### Manual Tests
1. **åŸºæœ¬ã‚¨ã‚³ãƒ¼é˜²æ­¢ãƒ†ã‚¹ãƒˆ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã™ â†’ ã‚·ã‚¹ãƒ†ãƒ ãŒå¿œç­” â†’ ãƒã‚¤ã‚¯ãŒè‡ªå‹•åœæ­¢/å†é–‹ã‚’ç¢ºèª

2. **ã‚¨ãƒ©ãƒ¼è€æ€§ãƒ†ã‚¹ãƒˆ**
   - éŸ³å£°åˆæˆã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒã‚¤ã‚¯çŠ¶æ…‹å¾©æ—§ã‚’ç¢ºèª
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®å‹•ä½œç¢ºèª

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**
   - é•·æ™‚é–“ã®å¯¾è©±ã§ã®ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯
   - è¤‡æ•°å›ã®åœæ­¢/å†é–‹ã‚µã‚¤ã‚¯ãƒ«ã®å®‰å®šæ€§

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
apps/web/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ voice-state-manager.ts          # çµ±åˆéŸ³å£°çŠ¶æ…‹ç®¡ç†
â”‚   â”œâ”€â”€ echo-cancellation.ts            # ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ adaptive-volume-control.ts      # å‹•çš„éŸ³é‡åˆ¶å¾¡
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useVoiceState.ts                # éŸ³å£°çŠ¶æ…‹ç®¡ç†Hook
â”‚   â””â”€â”€ useEchoPrevention.ts            # ã‚¨ã‚³ãƒ¼é˜²æ­¢Hook
â”œâ”€â”€ components/
â”‚   â””â”€â”€ VoiceInput.tsx                  # ãƒã‚¤ã‚¯åˆ¶å¾¡å¼·åŒ–
â””â”€â”€ test/
    â”œâ”€â”€ lib/
    â”‚   â”œâ”€â”€ voice-state-manager.test.ts
    â”‚   â””â”€â”€ echo-cancellation.test.ts
    â””â”€â”€ integration/
        â””â”€â”€ voice-echo-prevention.test.ts
```

## ğŸ¯ å„ªå…ˆé †ä½ã¨å®Ÿè£…é †åº

### ğŸ”¥ ç·Šæ€¥åº¦: High (Phase 1)
**ç›®æ¨™**: ã‚¨ã‚³ãƒ¼ãƒ«ãƒ¼ãƒ—ã®å³åº§åœæ­¢
- Task 1.1.1-1.1.3: åŸºæœ¬ãƒã‚¤ã‚¯åˆ¶å¾¡
- Task 1.2.1: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·

### ğŸ”§ é‡è¦åº¦: Medium (Phase 2) 
**ç›®æ¨™**: å …ç‰¢ãªçŠ¶æ…‹ç®¡ç†
- Task 2.1.1-2.1.2: VoiceStateManager
- Task 2.2.1: çµ±åˆUIæ›´æ–°

### âš¡ æ”¹å–„åº¦: Low (Phase 3)
**ç›®æ¨™**: é«˜åº¦ãªã‚¨ã‚³ãƒ¼å¯¾ç­–
- Task 3.1.1-3.1.2: AudioContextæ´»ç”¨

## ğŸš€ Phase 1 å®Ÿè£…é–‹å§‹

**å³åº§ã«å–ã‚Šçµ„ã‚€ã¹ãæœ€å°é™ã®ä¿®æ­£:**

1. `VoiceInput` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« `disabled` prop è¿½åŠ 
2. `ChatPage` ã§éŸ³å£°åˆæˆçŠ¶æ…‹ã¨é€£å‹•
3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä¿è­·ã®å®Ÿè£…

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ã‚³ãƒ¼ãƒ«ãƒ¼ãƒ—å•é¡Œã‚’æ ¹æœ¬çš„ã«è§£æ±ºã—ã€å®‰å®šã—ãŸéŸ³å£°å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚